name: uiux-gate

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled, unlabeled, edited]

jobs:
  gate:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      statuses: write

    steps:
      - name: Enforce UI/UX label gate
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull_request in payload; exiting.');
              return;
            }

            const requiredLabel = 'uiux-required';
            const approvedLabel = 'uiux-approved';
            const notRequiredLabel = 'uiux-not-required';

            // Only allow these GitHub users to apply the uiux-approved label.
            // (In practice, clawderdan applies it after June (subagent) says âœ….)
            const allowedApprovers = new Set(['clawderdan', 'june']);

            const number = pr.number;
            const sha = pr.head.sha;

            async function getLabels() {
              const res = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: number, per_page: 100 });
              return res.data.map(l => l.name);
            }

            async function addLabel(name) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: [name] });
            }

            async function removeLabel(name) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: number, name });
              } catch (e) {
                // ignore 404
                core.info(`removeLabel(${name}) -> ${e.status || e.message}`);
              }
            }

            async function setStatus(state, description) {
              await github.rest.repos.createCommitStatus({
                owner,
                repo,
                sha,
                state, // success | failure | pending | error
                context: 'uiux-gate',
                description,
                target_url: `https://github.com/${owner}/${repo}/pull/${number}`,
              });
            }

            const labels = await getLabels();
            const hasRequired = labels.includes(requiredLabel);
            const hasApproved = labels.includes(approvedLabel);
            const hasNotRequired = labels.includes(notRequiredLabel);

            // Default: require UI/UX review on all PRs unless explicitly exempted.
            if (!hasRequired && !hasNotRequired) {
              core.info(`Adding ${requiredLabel} to PR #${number}`);
              await addLabel(requiredLabel);
              labels.push(requiredLabel);
            }

            // If someone other than the allowed approvers adds uiux-approved, strip it.
            if (context.payload.action === 'labeled' && context.payload.label?.name === approvedLabel) {
              const sender = context.payload.sender?.login;
              if (!allowedApprovers.has(sender)) {
                core.warning(`Removing ${approvedLabel} applied by unauthorized user: ${sender}`);
                await removeLabel(approvedLabel);
              }
            }

            // Refresh label state after any mutation.
            const labels2 = await getLabels();
            const requiredNow = labels2.includes(requiredLabel);
            const approvedNow = labels2.includes(approvedLabel);
            const notRequiredNow = labels2.includes(notRequiredLabel);

            const gateRequired = requiredNow && !notRequiredNow;

            if (!gateRequired) {
              await setStatus('success', 'UI/UX gate not required');
              return;
            }

            if (approvedNow) {
              await setStatus('success', 'June UI/UX approved');
              return;
            }

            await setStatus('failure', 'Blocked: needs June UI/UX approval (uiux-approved)');
            core.setFailed('Blocked: needs June UI/UX approval');
